{% extends 'layouts/auth_base.html' %}
{% load i18n %}
{% load account %}

{% block title %}{% trans "Password Reset" %}{% endblock %}

{% block content %}
<div class="login-box">
  <div class="login-logo">
    <a href="/"><b>Trauck</b></a>
  </div>
  <div class="card">
    <div class="card-body login-card-body">
      <h4 class="text-center mb-3">{% trans "Password Reset" %}</h4>

      <p class="mb-3">
        {% trans "We have sent you an email. If you have not received it please check your spam folder." %}
      </p>

      <div id="resend-area" class="text-center">
        <form method="post" action="{% url 'account_reset_password' %}" id="resend-form">
          {% csrf_token %}
          <input type="hidden" name="email" value="{{ email|default:'' }}" id="resend-email">
          <button id="resend-btn" type="submit" class="btn btn-secondary" disabled aria-disabled="true">{% trans "Resend email" %}</button>
        </form>
  <p class="mt-2"><small id="countdown">{% trans "You can resend the email in" %} 05:00</small></p>
  <div id="resend-alert" class="mt-3" aria-live="polite" aria-atomic="true"></div>
      </div>

      <p class="mt-4 text-center">
        <a href="{% url 'account_login' %}">{% trans 'Sign in' %}</a>
        &nbsp;|&nbsp;
        <a href="{% url 'account_signup' %}">{% trans 'Sign up' %}</a>
      </p>
    </div>
  </div>
</div>

<script>
// Resend cooldown (3 minutes) client-side timer
(function(){
  const btn = document.getElementById('resend-btn');
  const countdown = document.getElementById('countdown');
  const form = document.getElementById('resend-form');
  const emailField = document.getElementById('resend-email');

  const COOLDOWN = 300; // seconds (5 minutes)
  const STORAGE_KEY = 'password_reset_last_sent';

  function formatTime(s){
    const mm = String(Math.floor(s/60)).padStart(2,'0');
    const ss = String(s%60).padStart(2,'0');
    return `${mm}:${ss}`;
  }

  function showToast(message, type='info'){
    // render inline bootstrap-style alert into #resend-alert
    const container = document.getElementById('resend-alert');
    if(container){
      const cls = (type==='success') ? 'alert-success' : (type==='error') ? 'alert-danger' : 'alert-info';
      container.innerHTML = `<div class="alert ${cls} alert-dismissible fade show" role="alert">${message}<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>`;
      return;
    }
    // fallback
    if(window.toastr){
      toastr[type](message);
      return;
    }
    alert(message);
  }

  function enableButton(){
    btn.disabled = false;
    btn.classList.remove('btn-secondary');
    btn.classList.add('btn-primary');
    btn.removeAttribute('aria-disabled');
    btn.focus();
    countdown.textContent = '';
  }

  function disableButtonAndStart(remaining){
    btn.disabled = true;
    btn.classList.remove('btn-primary');
    btn.classList.add('btn-secondary');
    btn.setAttribute('aria-disabled','true');

    const iv = setInterval(()=>{
      remaining -= 1;
      if(remaining <= 0){
        clearInterval(iv);
        enableButton();
        localStorage.removeItem(STORAGE_KEY);
        return;
      }
      countdown.textContent = `{{ _('You can resend the email in') }} ` + formatTime(remaining);
    },1000);
  }

  // compute remaining based on localStorage timestamp
  const last = localStorage.getItem(STORAGE_KEY);
  if(last){
    const elapsed = Math.floor((Date.now() - parseInt(last,10))/1000);
    if(elapsed >= COOLDOWN){
      enableButton();
    } else {
      disableButtonAndStart(COOLDOWN - elapsed);
    }
  } else {
    // no timestamp -> start disabled countdown (user just sent request)
    // set timestamp now to enforce cooldown
    localStorage.setItem(STORAGE_KEY, String(Date.now()));
    disableButtonAndStart(COOLDOWN);
  }

  // AJAX submit handler
  form.addEventListener('submit', function(ev){
    ev.preventDefault();
    if(btn.disabled) return;
    const email = emailField.value || '';
    const csrf = form.querySelector('input[name=csrfmiddlewaretoken]').value;

    fetch(form.action, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
        'X-CSRFToken': csrf,
      },
      body: new URLSearchParams({email: email}).toString()
    }).then(r=>{
      if(r.ok){
        showToast('{{ _('Password reset email resent. Check your inbox.') }}', 'success');
        // record time and restart cooldown
        localStorage.setItem(STORAGE_KEY, String(Date.now()));
        disableButtonAndStart(COOLDOWN);
      } else {
        showToast('{{ _('Unable to resend email. Try again later.') }}', 'error');
      }
    }).catch(()=>{
      showToast('{{ _('Network error. Try again later.') }}', 'error');
    });
  });

})();
</script>

{% endblock %}
